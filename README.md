# OpenCloudOS 9 服务器自动初始化脚本

## 功能介绍

本脚本用于自动初始化 OpenCloudOS 9 服务器，完成以下任务：

1. **修改主机名**
2. **配置静态网络**
3. **修改SSH端口**
4. **用户安全配置**（细粒度的账户登录控制）
5. **额外安全配置**（防火墙、Fail2ban等）
6. **管理员账户创建**（带SSH公钥配置）
7. **root账户登录控制**（密码和SSH登录）

## 项目结构

```
server_init/
├── run.sh               # 交互式菜单脚本
├── auto_init.sh         # 自动初始化脚本
├── pull.sh              # 拉取更新脚本
├── scripts/             # 脚本模块目录
│   ├── common.sh        # 通用函数模块
│   ├── hostname.sh      # 主机名配置模块
│   ├── network.sh       # 网络配置模块
│   ├── security.sh      # 安全配置模块
│   ├── ssh.sh           # SSH配置模块
│   ├── user.sh          # 用户管理模块
│   └── init.sh          # 共享初始化函数
├── .env.example         # 环境变量示例文件
├── .gitignore           # Git忽略文件
├── README.md            # 使用说明
├── source/              # 资源文件目录
│   └── ssh_key.pub      # SSH公钥文件
└── logs/                # 日志文件目录
```

## 使用方法

### 1. 准备工作

- 确保服务器运行 OpenCloudOS 9
- 以 root 权限执行脚本
- 确保服务器可以访问网络（用于安装依赖）
- 确保git服务可用，如果不可用，就用`sudo dnf install git -y`安装

### 2. 配置步骤

1. **克隆项目**
   ```bash
   git clone https://github.com/vermantor/server_init.git
   cd server_init
   ```

2. **配置环境变量**
   - 复制环境变量示例文件并编辑
   ```bash
   cp .env.example .env
   vim .env
   ```

   - 编辑 .env 文件，根据实际情况修改以下配置：
     - `HOSTNAME`: 服务器主机名
     - `NETWORK_INTERFACE`: 网络接口名称（如 eth0，留空则自动检测）
     - `IP_ADDRESS`: 静态IP地址
     - `NETMASK`: 子网掩码
     - `GATEWAY`: 网关地址
     - `DNS_SERVERS`: DNS服务器地址
     - `SSH_PORT`: SSH端口（建议修改为非默认端口）
     - `SSH_USER`: SSH登录用户
     - `PASSWORD_AUTHENTICATION`: 是否启用密码验证（yes/no）
     - `ENABLE_FIREWALL`: 是否启用防火墙（yes/no）
     - `INSTALL_FAIL2BAN`: 是否安装Fail2ban（yes/no）

3. **执行初始化脚本**
   
   有两种执行方式：
   
   - **方式一：直接执行完整初始化**
     ```bash
     # 执行脚本（需要root权限）
     sudo bash auto_init.sh
     ```
   
   - **方式二：使用可视化界面**（推荐）
     ```bash
     # 执行脚本（需要root权限）
     sudo bash run.sh
     ```

### 3. 执行流程

#### 方式一：直接执行完整初始化
脚本执行过程中会：
- 检查是否以root权限执行
- 加载各个脚本模块
- 加载环境变量配置
- 自动检测网络接口（如果未指定）
- 按顺序执行各个初始化步骤：
  - 配置主机名
  - 配置网络
  - 配置SSH端口
  - 配置安全设置（防火墙、Fail2ban）
  - 添加管理员账户
  - 配置管理员账户的SSH公钥
  - 禁用root密码登录
  - 禁用root SSH登录
  - 显示账户登录状态
- 记录执行日志到 `init.log` 文件
- 提示用户登录并设置密码
* 注意：
  - 完整初始化方式将会禁用远程密码认证`PasswordAuthentication`，所有通过SSH密码登录的用户都将被禁用。
  - 完整初始化方式将会禁用root账户的远程登陆`PermitRootLogin`，[密码/密钥等试都将被禁用]。
  - 完整初始化方式将会创建部分锁定的管理员账户`-p '*'`，将只被允许通过SSH密钥方式登录。
  - 请提前配置好管理员账户的SSH公钥，避免无法登录服务器。
  - 解锁创建账户的密码登陆：如果需要恢复登录，可以通过命令 `passwd [用户名]` 解锁账户的密码登录。
  - 总结：完整初始化方式下你只能：
    - 以root账户本地登陆服务器。
    - 以管理员账户通过SSH密钥登录服务器，可以su切换到root账户。
#### 方式二：使用可视化界面
可视化界面提供以下功能：
1. **执行完整初始化**：执行所有初始化步骤
2. **配置主机名**：设置服务器主机名
3. **配置网络**：自动检测网络接口并配置静态网络
4. **添加管理员账户**：创建并启用新账户，配置管理权限
5. **配置添加的管理员账户的SSH公钥**：为管理员账户配置SSH公钥
6. **配置SSH端口**：修改默认的22端口
7. **配置安全设置**：配置防火墙、配置Fail2ban
8. **禁用root密码登录**：禁用root账户的密码登录
9. **禁用root SSH登录**：禁用root账户的SSH登录
10. **允许root密码登录**：允许root账户的密码登录
11. **允许root SSH登录**：允许root账户的SSH登录
12. **允许管理员密码登录**：允许管理员账户的密码登录
13. **禁止管理员密码登录**：禁止管理员账户的密码登录
14. **允许管理员SSH登录**：允许管理员账户的SSH登录
15. **禁止管理员SSH登录**：禁止管理员账户的SSH登录
16. **查看执行日志**：查看详细的执行日志
17. **退出**：退出可视化界面

界面操作说明：
- 输入对应数字选择操作
- 执行完成后按 Enter 键返回菜单
- 所有操作都会记录到 `init.log` 文件
- 操作后会显示账户登录状态

### 4. 验证配置

执行完成后，建议验证以下配置：

- **主机名**：执行 `hostname` 命令查看
- **网络配置**：执行 `ip addr` 命令查看
- **SSH配置**：尝试使用新端口连接SSH
- **账户状态**：执行脚本中的账户状态显示功能查看

## 注意事项

1. **备份重要数据**：执行脚本前请备份重要数据
2. **网络配置**：修改网络配置后，服务器可能会暂时断开连接，请确保配置正确
3. **SSH端口**：修改SSH端口后，需要使用新端口连接
4. **防火墙**：启用防火墙后，需要确保必要的端口已开放
5. **密码设置**：首次登录时系统会要求设置密码，因为账户创建时未配置初始密码

## 故障排除

- **脚本执行失败**：查看 `init.log` 文件了解详细错误信息
- **网络连接问题**：检查网络配置是否正确
- **SSH连接问题**：检查防火墙规则和SSH配置
- **账户登录问题**：检查账户状态和权限设置

## 安全建议

1. 使用强密码
2. 定期更新系统
3. 启用防火墙
4. 安装Fail2ban防止暴力破解
5. 定期备份重要数据
6. 禁用root账户登录，使用普通账户加sudo权限

## 贡献

欢迎提交问题和改进建议！

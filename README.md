# OpenCloudOS 9 服务器自动初始化脚本

## 功能介绍

本脚本用于自动初始化 OpenCloudOS 9 服务器，完成以下任务：

1. **修改主机名**
2. **配置静态网络**
3. **修改SSH端口**
4. **生成SSH密钥对**
5. **用户安全配置**（禁用root登录、配置密码验证等）
6. **额外安全配置**（防火墙、Fail2ban等）
7. **中文语言支持**（安装中文语言包、配置中文环境）

## 项目结构

```
server_init/
├── main.sh              # 统一执行脚本
├── menu.sh              # 可视化界面脚本
├── scripts/             # 脚本模块目录
│   ├── common.sh        # 通用函数模块
│   ├── language.sh      # 语言支持模块
│   ├── network.sh       # 网络配置模块
│   ├── ssh.sh           # SSH配置模块
│   └── security.sh      # 安全配置模块
├── .env.example         # 环境变量示例文件
├── init.sh              # 原脚本（保留作为备份）
└── README.md            # 使用说明
```

## 使用方法

### 1. 准备工作

- 确保服务器运行 OpenCloudOS 9
- 以 root 权限执行脚本
- 确保服务器可以访问网络（用于安装依赖，脚本会自动检查并安装git）

### 2. 配置步骤

1. **克隆项目**
   ```bash
   git clone https://github.com/vermantor/server_init.git
   cd server_init
   ```

2. **配置环境变量**
   - 复制环境变量示例文件并编辑
   ```bash
   cp .env.example .env
   vim .env
   ```

   - 编辑 .env 文件，根据实际情况修改以下配置：
     - `HOSTNAME`: 服务器主机名
     - `NETWORK_INTERFACE`: 网络接口名称（如 eth0，留空则自动检测）
     - `IP_ADDRESS`: 静态IP地址
     - `NETMASK`: 子网掩码
     - `GATEWAY`: 网关地址
     - `DNS_SERVERS`: DNS服务器地址
     - `SSH_PORT`: SSH端口（建议修改为非默认端口）
     - `SSH_USER`: SSH登录用户
     - `PASSWORD_AUTHENTICATION`: 是否启用密码验证（yes/no）
     - `ENABLE_FIREWALL`: 是否启用防火墙（yes/no）
     - `INSTALL_FAIL2BAN`: 是否安装Fail2ban（yes/no）

3. **执行初始化脚本**
   
   有两种执行方式：
   
   - **方式一：直接执行完整初始化**
     ```bash
     # 执行脚本（需要root权限）
     sudo bash main.sh
     ```
   
   - **方式二：使用可视化界面**（推荐）
     ```bash
     # 执行脚本（需要root权限）
     sudo bash menu.sh
     ```

### 3. 执行流程

#### 方式一：直接执行完整初始化
脚本执行过程中会：
- 检查是否以root权限执行
- 加载各个脚本模块
- 配置中文语言支持
- 加载环境变量配置
- 自动检测网络接口（如果未指定）
- 按顺序执行各个初始化步骤：
  - 配置主机名
  - 配置网络
  - 配置SSH端口
  - 生成SSH密钥对
  - 配置SSH安全设置
  - 配置防火墙
  - 配置Fail2ban
- 记录执行日志到 `init.log` 文件

#### 方式二：使用可视化界面
可视化界面提供以下功能：
1. **执行完整初始化**：执行所有初始化步骤
2. **配置语言支持**：安装中文语言包并配置中文环境
3. **配置主机名**：设置服务器主机名
4. **配置网络**：自动检测网络接口并配置静态网络
5. **配置SSH**：修改SSH端口、生成密钥对、配置安全设置
6. **配置安全设置**：启用防火墙和Fail2ban
7. **配置用户权限**：禁用root账户、创建并启用新账户
8. **配置Git**：检查并安装Git
9. **查看执行日志**：查看详细的执行日志
10. **退出**：退出可视化界面

界面操作说明：
- 输入对应数字选择操作
- 执行完成后按 Enter 键返回菜单
- 所有操作都会记录到 `init.log` 文件

### 4. 验证配置

执行完成后，建议验证以下配置：

- **主机名**：执行 `hostname` 命令查看
- **网络配置**：执行 `ip addr` 命令查看
- **SSH配置**：尝试使用新端口连接SSH
- **密钥对**：检查 `~/.ssh/` 目录下的密钥文件

## 注意事项

1. **备份重要数据**：执行脚本前请备份重要数据
2. **网络配置**：修改网络配置后，服务器可能会暂时断开连接，请确保配置正确
3. **SSH端口**：修改SSH端口后，需要使用新端口连接
4. **防火墙**：启用防火墙后，需要确保必要的端口已开放
5. **密钥对**：生成的私钥请妥善保存，不要泄露

## 故障排除

- **脚本执行失败**：查看 `init.log` 文件了解详细错误信息
- **网络连接问题**：检查网络配置是否正确
- **SSH连接问题**：检查防火墙规则和SSH配置

## 安全建议

1. 使用强密码
2. 定期更新系统
3. 启用防火墙
4. 安装Fail2ban防止暴力破解
5. 定期备份重要数据

## 贡献

欢迎提交问题和改进建议！
